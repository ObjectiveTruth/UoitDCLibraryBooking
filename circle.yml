machine:
  node:
    version: 5.5.0
  environment:
    ADB_INSTALL_TIMEOUT: "10"
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
  post:
    # Creates a random introspective tunnel to the CircleCI container
    - wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
    - unzip ngrok-stable-linux-amd64.zip
    - ./ngrok http -log $CIRCLE_ARTIFACTS/ngrok.log -log-level debug -log-format json 9292:
        background: true
    - sleep 2
    # Save the NGROK URL by using the API on the ngrok server and appending the desired callback url
    - echo "$(curl 127.0.0.1:4040/api/tunnels | jq '.tunnels[0].public_url' -r)"/reply > UoitDCLibraryBooking/ngrok_url.txt

dependencies:
  override:
    - npm install:
        pwd:
          device_farm_receive_server
  pre:
    - echo y | android update sdk --no-ui --all --filter tool,extra-android-m2repository,extra-android-support,extra-google-google_play_services,extra-google-m2repository,android-23
    - echo y | android update sdk --no-ui --all --filter "build-tools-23.0.2"
  post:
    # Copy the standard debug keystore to the CI, ensuring all app have the same certificate
    - cp UoitDCLibraryBooking/debug.keystore ~/.android/

test:
  override:
    # Assemble the AndroidTest Instrumentation build in build/outputs/apk
    - ./gradlew assembleAndroidTest
    # Assemble the debug build in build/outputs/apk
    - ./gradlew assembleDebug

    # Run the device_farm_receive_server and write the exit state to $DEVICE_FARM_RECEIVE_SERVER_RESPONSE
    # Needs to be written to a variable because failing any command will fail the build
    - node server.js:
        pwd:
          device_farm_receive_server

    - ./scripts/circle_ci_emulator_tests.sh:
        timeout: 900

    # Copy the build outputs and spoon to artifacts
    - cp -rv UoitDCLibraryBooking/build/outputs $CIRCLE_ARTIFACTS

    # copy the test results to the test results directory if any. (dont fail the build if they don't exist)
    - cp -rv UoitDCLibraryBooking/build/outputs/spoon/junit-reports $CIRCLE_TEST_REPORTS/junit || true

notify:
  webhooks:
    # When build completes, send the Device Farm server the results so it can decide if a release is a good idea
    - url: https://skzyy6va72.execute-api.us-west-2.amazonaws.com/prod/circlecibuildfinishwebhook

